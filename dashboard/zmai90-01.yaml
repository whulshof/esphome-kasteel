substitutions:
  name: "ZMAi-90"
  friendly_name: "WP Loods2"
  node_name: zmai90-01
  static_ip_outdoor: 192.168.5.21
  static_ip_kasteel: 10.222.15.36

esphome:
  platform: ESP8266
  board: esp12e
  name: $node_name

# Enable Home Assistant API
api:
  password: !secret api_password

# Make sure you can upload new firmware OTA
ota:
  password: !secret ota_password

wifi:
  # use_address: 10.222.15.36
  power_save_mode: light
  # networks:
  # - ssid: !secret wifi_ssid_outdooreap
  #   password: !secret wifi_password_outdooreap
  #   manual_ip:
  #     static_ip: $static_ip_outdoor
  #     gateway: 192.168.5.1
  #     subnet: 255.255.255.224
  ssid: !secret wifi_ssid_outdoorwrt
  password: !secret wifi_password_outdoorwrt
  manual_ip:
    static_ip: $static_ip_outdoor
    gateway: 192.168.5.1
    subnet: 255.255.255.0
  # - ssid: !secret wifi_ssid_kasteel
  #   password: !secret wifi_password_kasteel  
  #   manual_ip:
  #     static_ip: $static_ip_kasteel
  #     gateway: 10.222.14.138
  #     subnet: 255.255.254.0

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "${friendly_name} Fallback Hotspot"
    password: !secret ap_password

captive_portal:

web_server:
  port: 80
  auth:
    username: !secret web_username # disabled if absent or empty
    password: !secret web_password # disabled if absent or empty

# Enable logging
logger:
  baud_rate: 0

uart:
  rx_pin: GPIO3
  tx_pin: GPIO1
  baud_rate: 9600
  #parity: EVEN


external_components:
  - source: github://dentra/esphome@tuya-raw-fix-standalone
    components: ["tuya"]
  - source: github://dentra/esphome-components

# Example configuration entry
time:
  - platform: homeassistant
    id: homeassistant_time

# Register the Tuya MCU connection
tuya:
  on_datapoint_update:
    - sensor_datapoint: 6
      datapoint_type: raw
      then:
        - lambda: |-
            id(voltage).publish_state((x[0] << 8 | x[1]) * 0.1);
            id(current).publish_state((x[3] << 8 | x[4]) * 0.001);
            id(power).publish_state((x[6] << 8 | x[7]));

sensor:
  # total
  - platform: "tuya"
    id: total
    name: "Energy Total"
    sensor_datapoint: 1
    accuracy_decimals: 3
    filters:
      - multiply: 0.01
    unit_of_measurement: "kWh"
    icon: "mdi:sigma"
    device_class: "energy"
  # voltage
  - platform: template
    id: voltage
    name: "Voltage"
    unit_of_measurement: "V"
    icon: "mdi:sine-wave"
    device_class: "voltage"
  # current
  - platform: template
    id: current
    name: "Current"
    unit_of_measurement: "A"
    icon: "mdi:current-ac"
    device_class: "current"
  # active power
  - platform: template
    id: power
    name: "Active Power"
    unit_of_measurement: "W"
    accuracy_decimals: 0
    icon: "mdi:flash"
    device_class: "power"
  # energy_monitoring
  - platform: "energy_monitoring"
    power: power
    voltage: voltage
    current: current
    apparent_power:
      name: "Apparent Power"
    reactive_power:
      name: "Reactive Power"
    power_factor:
      name: "Power Factor"
      
# WIFI signal level every 60s
  - platform: wifi_signal
    name: "${friendly_name} WiFi Signal"
    update_interval: 60s

# power switch
switch:
   - platform: "tuya"
     name: "Power"
     switch_datapoint: 16
     icon: "mdi:power"
     
# connection status
binary_sensor:
  - platform: status
    name: "${friendly_name} Status"

# esphome version
text_sensor:
  - platform: version
    name: "${friendly_name} ESPHome Version"
  - platform: wifi_info
    ip_address:
      name: "${friendly_name} IP Address"
    ssid:
      name: "${friendly_name} SSID"
    bssid:
      name: "${friendly_name} BSSID"
    mac_address:
      name: "${friendly_name} Mac Wifi Address"